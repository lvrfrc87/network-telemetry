stages:
  - build_env
  - syntax_check
  - docker_prov
  - deployment

cache:
  paths:
    - telemetry/
  policy: pull-push

build:
  stage: build_env
  tags:
  - build_env
  script:
  - sudo apt-get update && sudo apt-get upgrade -y
  - sudo apt-get install python3-pip -y
  - sudo pip3 install --upgrade pip
  - sudo pip3 install virtualenv
  - virtualenv telemetry
  - source telemetry/bin/activate

python:
  stage: syntax_check
  tags:
  - syntax_check
  script:
  - sudo pip3 install jinja2
  - sudo pip3 install credPass
  - sudo pip3 install influxdb
  - sudo pip3 install pylint
  - pylint --const-rgx='[a-z_][a-z0-9_]{2,30}$' *

yaml:
  stage: syntax_check
  tags:
  - syntax_check
  script:
  - sudo pip3 install yamllint
  - yamllint *

json:
  stage: syntax_check
  tags:
  - syntax_check
  script:
  - sudo apt-get install nodejs-legacy -y
  - sudo apt-get install npm -y
  - sudo npm install jsonlint -g
  - jsonlint *


Dockerfile:
  stage: syntax_check
  tags:
  - syntax_check
  script:
  - wget -cO hadolint https://github.com/hadolint/hadolint/releases/download/v1.13.0/hadolint-Linux-x86_64
  - chmod +x hadolint
  - ./hadolint *

syntax_check:
  stage: syntax_check
  tags:
  - syntax_check
  script:
  - source telemetry/bin/activate
  # - yamllint tcp-probes/var/
  - yamllint ping-probes/var/
  # - pylint --const-rgx='[a-z_][a-z0-9_]{2,30}$' tcp-probes/*.py
  - pylint --const-rgx='[a-z_][a-z0-9_]{2,30}$' ping-probes/*.py
  # - jsonlint tcp-probes/*.json
  - jsonlint ping-probes/.credentials.json
  - sudo wget https://github.com/hadolint/hadolint/releases/download/v1.13.0/hadolint-Linux-x86_64 -o hadolint && sudo chmod +x hadolint
  - ./hadolint ping-probes/Dockerfile
